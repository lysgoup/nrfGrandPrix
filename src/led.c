#include "./include/led.h"
#include "./include/value.h"

int number_led_matrix_arr [MAX_LED_MATRIX_IDX+1][MAX_LED_MATRIX_NUM+1];
int led_matrix_arr [3][MAX_LED_NUM+1];
int led_map [MAX_LED_MATRIX_ROW][MAX_LED_MATRIX_COL*6];

// Function to initialize the LED matrix
int led_init(void)
{
    if(!device_is_ready(led)){
        printk("LED device %s is not ready\n", led->name);
        return DK_ERR;
    }

    for(int i = 0; i< MAX_LED_NUM; i++){
        led_off(led, i);
    }

    return DK_OK;
}

void led_on_mid(){
    led_on(led, 49);
    led_on(led, 50);
    led_on(led, 51);
    led_on(led, 65);
    // led_on(led, 66);
    led_on(led, 67);
}
void led_on_top(){
    led_on(led, 1);
    led_on(led, 2);
    led_on(led, 3);
    led_on(led, 17);
    // led_on(led, 18);
    led_on(led, 19);
}
void led_on_bot(){
    led_on(led, 97);
    led_on(led, 98);
    led_on(led, 99);
    led_on(led, 113);
    // led_on(led, 114);
    led_on(led, 115);
}
void led_off_mid(){
    led_off(led, 48);
    led_off(led, 49);
    led_off(led, 50);
    led_off(led, 64);
    led_off(led, 65);
    led_off(led, 66);
}
void led_off_top(){
    led_off(led, 0);
    led_off(led, 1);
    led_off(led, 2);
    led_off(led, 16);
    led_off(led, 17);
    led_off(led, 18);
}
void led_off_bot(){
    led_off(led, 96);
    led_off(led, 97);
    led_off(led, 98);
    led_off(led, 112);
    led_off(led, 113);
    led_off(led, 114);
}

void led_on_seconds(int num)
{
    int tens = num / 10;
    int units = num % 10;

    int num_arr_idx = 0;

    for(int i = 0; i < MAX_LED_NUM; i+=16){
        for(int j = i; j < (i+8); j++){
            if(number_led_matrix_arr[tens][num_arr_idx] == 1){
                // printk("[tens] led_on: j:[%d] num_array_idx[%d]\n", j, num_arr_idx);
                led_on(led, j);
            } else {
                led_off(led, j);
            }

            num_arr_idx++;
        }
    }

    num_arr_idx = 0;

    for(int i = 0; i < MAX_LED_NUM; i+=16){
        for(int j = (i+8); j < (i+16); j++){
            if(number_led_matrix_arr[units][num_arr_idx] == 1){
                // printk("[units] led_on: j:[%d] num_array_idx[%d]\n", j, num_arr_idx);
                led_on(led, j);
            } else {
                led_off(led, j);
            }
            num_arr_idx++;
        }
    }
}

void led_on_status(int type){
    for(int i = 0; i < MAX_LED_NUM; i++){
        if(led_matrix_arr[type][i] == 1){
            // printk("[tens] led_on: j:[%d] num_array_idx[%d]\n", j, num_arr_idx);
            led_on(led, i);
        } else {
            led_off(led, i);
        }
    }
}

void led_blink_status(int type, uint32_t on_time, uint32_t off_time){
    for(int i = 0 ; i <=MAX_LED_NUM; i++){
        if(led_matrix_arr[type][i]){
            led_blink(led, i, on_time, off_time);
        }
    }
    k_msleep(5000);
    led_blink(led, 0, 0, 0);
}

int show_map(int second, int pos){
    int start_col = second % (MAX_LED_MATRIX_COL * 6 + 1 - 16); // 시작 열 계산
    if(start_col == 0 && second != 0){return -1;} // 마지막 순간
    for (int row = 0; row < 8; row++) {
        for (int col = 0; col < 16; col++) {
            int led_index = row * 16 + col;
            if (led_map[row][start_col + col]) {
                led_on(led, led_index); // 해당 LED를 켭니다.
            } else {
                led_off(led, led_index); // 해당 LED를 끕니다.
            }
        }
    }
    if(pos == MID){
        led_on_mid();
        led_off_top();
        led_off_bot();
        if(led_map[3][start_col+1]==1 || led_map[3][start_col+2]==1 || led_map[3][start_col+2]==1 || led_map[4][start_col+1]==1 || led_map[4][start_col+2]==1 || led_map[4][start_col+2]==1){
            return -2;
        }
    }
    else if(pos == TOP){
        led_off_mid();
        led_on_top();
        led_off_bot();
        if(led_map[0][start_col+1]==1 || led_map[0][start_col+2]==1 || led_map[0][start_col+2]==1 || led_map[1][start_col+1]==1 || led_map[1][start_col+2]==1 || led_map[1][start_col+2]==1){
            return -2;
        }
    }
    else{
        led_off_mid();
        led_off_top();
        led_on_bot();
        if(led_map[6][start_col+1]==1 || led_map[6][start_col+2]==1 || led_map[6][start_col+2]==1 || led_map[7][start_col+1]==1 || led_map[7][start_col+2]==1 || led_map[7][start_col+2]==1){
            return -2;
        }
    }
    return 0;
}

int led_matrix_arr [3][MAX_LED_NUM+1]= {
    {//WAIT
        0,0,0,0,0, 0,0,0,0, 0, 0,0,0, 0,0,0,
        0,0,0,0,0, 0,0,0,0, 0, 0,0,0, 0,0,0,
        1,0,1,0,1, 0,1,1,0, 0, 1,1,1, 1,1,1,
        1,0,1,0,1, 1,0,0,1, 0, 0,1,0, 0,1,0,
        1,0,1,0,1, 1,1,1,1, 0, 0,1,0, 0,1,0,
        1,0,1,0,1, 1,0,0,1, 0, 0,1,0, 0,1,0,
        0,1,0,1,0, 1,0,0,1, 0, 1,1,1, 0,1,0,
        0,0,0,0,0, 0,0,0,0, 0, 0,0,0, 0,0,0
    },
    {//PASS
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        1,1,1,0,0,1,1,0,1,1,1,1,1,1,1,1,
        1,0,0,1,1,0,0,1,1,0,0,0,1,0,0,0,
        1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,
        1,0,0,0,1,0,0,1,0,0,0,1,0,0,0,1,
        1,0,0,0,1,0,0,1,1,1,1,1,1,1,1,1,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    },
    {//FAIL
        0,0,0,0,0,0,0,0, 0,0,0,0, 0,0,0,0,
        0,0,0,0,0,0,0,0, 0,0,0,0, 0,0,0,0,
        1,1,1,1,0,1,0,0, 1,1,1,0, 1,0,0,0,
        1,0,0,0,1,0,1,0, 0,1,0,0, 1,0,0,0,
        1,1,1,0,1,1,1,0, 0,1,0,0, 1,0,0,0,
        1,0,0,1,0,0,0,1, 0,1,0,0, 1,0,0,0,
        1,0,0,1,0,0,0,1, 1,1,1,0, 1,1,1,1,
        0,0,0,0,0,0,0,0, 0,0,0,0, 0,0,0,0
    }
};

int number_led_matrix_arr [MAX_LED_MATRIX_IDX+1][MAX_LED_MATRIX_NUM+1]= {

    { // 0
        0,0,0,1,1,1,0,0,
        0,0,1,0,0,0,1,0,
        0,0,1,0,0,0,1,0,
        0,0,1,0,0,0,1,0,
        0,0,1,0,0,0,1,0,
        0,0,1,0,0,0,1,0,
        0,0,1,0,0,0,1,0,
        0,0,0,1,1,1,0,0
    },
    { // 1
        0,0,0,0,1,0,0,0,
        0,0,0,1,1,0,0,0,
        0,0,1,0,1,0,0,0,
        0,0,0,0,1,0,0,0,
        0,0,0,0,1,0,0,0,
        0,0,0,0,1,0,0,0,
        0,0,0,0,1,0,0,0,
        0,0,1,1,1,1,1,0
    },
    { // 2
        0,0,0,0,1,0,0,0,
        0,0,0,1,0,1,0,0,
        0,0,1,0,0,0,1,0,
        0,0,0,0,0,1,0,0,
        0,0,0,0,1,0,0,0,
        0,0,0,1,0,0,0,0,
        0,0,1,0,0,0,0,0,
        0,0,1,1,1,1,1,0
    },
    { // 3
        0,0,1,1,1,1,0,0,
        0,0,0,0,0,0,1,0,
        0,0,0,0,0,0,1,0,
        0,0,1,1,1,1,0,0,
        0,0,0,0,0,0,1,0,
        0,0,0,0,0,0,1,0,
        0,0,0,0,0,0,1,0,
        0,0,1,1,1,1,0,0
    },
    { // 4
        0,0,0,0,0,1,0,0,
        0,0,0,0,1,1,0,0,
        0,0,0,1,0,1,0,0,
        0,0,1,0,0,1,0,0,
        0,1,1,1,1,1,1,0,
        0,0,0,0,0,1,0,0,
        0,0,0,0,0,1,0,0,
        0,0,0,0,0,1,0,0
    },
    { // 5
        0,0,1,1,1,1,1,0,
        0,0,1,0,0,0,0,0,
        0,0,1,0,0,0,0,0,
        0,0,1,1,1,1,0,0,
        0,0,0,0,0,0,1,0,
        0,0,0,0,0,0,1,0,
        0,0,1,0,0,0,1,0,
        0,0,0,1,1,1,0,0
    },
    { // 6
        0,0,0,1,1,1,0,0,
        0,0,1,0,0,0,0,0,
        0,0,1,0,0,0,0,0,
        0,0,1,1,1,1,0,0,
        0,0,1,0,0,0,1,0,
        0,0,1,0,0,0,1,0,
        0,0,1,0,0,0,1,0,
        0,0,0,1,1,1,0,0
    },
    { // 7
        0,0,1,1,1,1,1,0,
        0,0,1,0,0,0,1,0,
        0,0,1,0,0,0,1,0,
        0,0,1,0,0,0,1,0,
        0,0,0,0,0,0,1,0,
        0,0,0,0,0,0,1,0,
        0,0,0,0,0,0,1,0,
        0,0,0,0,0,0,1,0
    },
    { // 8
        0,0,0,1,1,1,0,0,
        0,0,1,0,0,0,1,0,
        0,0,1,0,0,0,1,0,
        0,0,0,1,1,1,0,0,
        0,0,1,0,0,0,1,0,
        0,0,1,0,0,0,1,0,
        0,0,1,0,0,0,1,0,
        0,0,0,1,1,1,0,0
    },
    { // 9
        0,0,0,1,1,1,0,0,
        0,0,1,0,0,0,1,0,
        0,0,1,0,0,0,1,0,
        0,0,1,0,0,0,1,0,
        0,0,0,1,1,1,1,0,
        0,0,0,0,0,0,1,0,
        0,0,0,0,0,0,1,0,
        0,0,0,0,0,0,1,0
    }
};

int led_map [8][MAX_LED_MATRIX_COL*6] = {
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, 1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, 0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0, 1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, 0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0, 1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, 1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, 0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0, 1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0, 1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1},  
    {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, 1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, 1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0, 0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1}, 
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, 1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, 1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0, 0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1},  
    {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
    {0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, 1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1},  
    {0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, 1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1}
};